/*
	Name: jakach av3
	Copyright: Janis Steiner / Jakach
	Author: Janis Steiner
	Date: 16.03.23 16:36
	Description: main file and sourcecode of jakach/av3
*/
/* .cpp Files used in this file
	header/scan/scan.cpp
	header/hash/hash.cpp
	header/update/update.cpp 
*/

#include <iostream>
#include <cstring>
#include <dirent.h>
#include <sys/stat.h>
#include "header/scan/scan.h"
#include "header/hash/hash.h"
#include "header/update/update.h"
#include "header/sumary/summary.h"
#include "header/os.h"
#ifdef os_win
#include <windows.h>
#endif
#ifdef os_linux
bool is_file(const char* path) {
    struct stat path_stat;
    if (stat(path, &path_stat) != 0) {
        return false;
    }
    return S_ISREG(path_stat.st_mode);
}
#endif
int main( int argc, char *argv[])
{
	FILE*virus;
	char path_a[400];
	if(argc<2)
	{
		printf("usage: %s\n[--update-db / -u]\n[--scanhash <hash> / -h <hash>]\n[--scanfile <file> / -s <file>]\n[--scanfolder <folder> / -f <folder>]\n[--scanfolderrecursive <folder> / -r <folder>]\n[--version / -v]\n", argv[0]);
		exit(0);
	}
	if(strcmp("--update-db",argv[1])==0 or strcmp("-u",argv[1])==0)
	{
		donwload_preindexed_files();
		//download_files();
		//if(make_db()!=0)
		//	printf("Error, could not make db!\n");
	}
	else if(strcmp("--version",argv[1])==0 or strcmp("-v",argv[1])==0 )
	{
		printf("Jakach av3\nVersion: 1.0.0\n");
	}
	else if(strcmp("--scanhash",argv[1])==0 or strcmp("-h",argv[1])==0 )
	{
		printf("scanning hash...\n");
		switch(scan_hash(argv[2]))
		{
			case 0:
				printf("All good, no virus found!\n");
			break;
			case 1:
				printf("Warning, virus found!\n");
			break;
			default:
				printf("Error, an error occured while scanning!\n");
			break;
		}
	}
	else if(strcmp("--scanfile",argv[1])==0 or strcmp("-s",argv[1])==0 )
	{
		char hash[50];
		if(get_hash(argv[2],hash)==0)
		{
			printf("Error, an error occured while scanning!\n");
		}
		else
		{
			printf("scanning file %s...\n",argv[2]);
			switch(scan_hash(hash))
			{
				case 0:
					printf("All good, no virus found!\n");
				break;
				case 1:
					printf("Warning, virus found!\n");
				break;
				default:
					printf("Error, an error occured while scanning!\n");
				break;
			}			
		}
	}
	else if(strcmp("--scanfolder",argv[1])==0 or strcmp("-f",argv[1])==0 )
	{
		//loop throu items
		DIR *dp; //this works cross platform :)
		struct dirent *ep;
		char a[300];
		char hash[50];
		char fullpath[500];
		dp = opendir (argv[2]);
		if (dp != NULL)
		{
			while (ep = readdir (dp))
			{
				strcpy(a,ep->d_name);
				#ifdef os_win
				if((virus=fopen("c:\\programdata\\jakach\\se\\hashes\\virus.jdbf","w"))==0)
					return 2;
				#endif
				#ifdef os_linux
				if((virus=fopen("/etc/jakach/virus.jdbf","w"))==0)
					return 2;
				#endif
				#ifdef os_win
				sprintf(fullpath,"%s\\%s",argv[2],a);
				DWORD attrs = GetFileAttributesA(fullpath);
			    if (attrs & FILE_ATTRIBUTE_DIRECTORY) {
			    	//folder
			    }
			    else
				{
					printf("Scanning file %s...\n",fullpath);
					if(get_hash(fullpath,hash)==0)
					{
						printf("Error, an error occured while scanning!\n");
					}
					switch(scan_hash(hash))
					{
						case 0:
							printf("All good, no virus found!\n");
						break;
						case 1:
							printf("Warning, virus found!\n");
							fprintf(virus,"%s\n",fullpath);
						break; 
						default:
							printf("Error, an error occured while scanning!\n");
						break; 
					}			
				}
				#endif 
				#ifdef os_linux
				strcpy(a,ep->d_name);
				sprintf(fullpath,"%s\\%s",argv[2],a);
				if(is_file(fullpath))
				{
					printf("Scanning file %s...\n",fullpath);
					if(get_hash(fullpath,hash)==0)
					{
						printf("Error, an error occured while scanning!\n");
					}
					switch(scan_hash(hash))
					{
						case 0:
							printf("All good, no virus found!\n");
						break;
						case 1:
							printf("Warning, virus found!\n");
							fprintf(virus,"%s\n",fullpath);
						break;
						default:
							printf("Error, an error occured while scanning!\n");
						break;
					} 					
				}
				#endif
			} 
		}
		(void) closedir (dp);
		fclose(virus);
		print_sumary();
	}
	else if(strcmp("--scanfolderrecursive",argv[1])==0 or strcmp("-r",argv[1])==0 )
	{
		scan_recursive_dir(argv[2]);
		print_sumary();
	}
	else
	{
		printf("Error, command not found!\n");

	}
	return 0;
}
