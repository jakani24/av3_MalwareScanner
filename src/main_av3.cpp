/*
	Name: jakach av3
	Copyright: Janis Steiner / Jakach
	Author: Janis Steiner
	Date: 16.03.23 16:36
	Description: main file and sourcecode of jakach/av3
*/



#include <iostream>
#include <cstring>
#include <dirent.h>
#include <unistd.h>
#include <sys/stat.h>
#include "header/scan/scan.h"
#include "header/hash/hash.h"
#include "header/update/update.h"
#include "header/sumary/summary.h"
#include "header/os.h"
#ifdef os_win
#include <windows.h>
#endif
#ifdef os_linux
bool is_file(const char* path)
{
	struct stat path_stat;
	if (stat(path, &path_stat) != 0) {
		return false;
	}
	return S_ISREG(path_stat.st_mode);
}
#endif
int main( int argc, char *argv[])
{
	FILE*virus;
	char path_a[400];
	char hash[50];

	DIR *dp;
	struct dirent *ep;
	char a[300];
	char fullpath[500];

	//Show help Menu
	if(argc<2 or strcmp(argv[1],"--help")==0 or strcmp(argv[1],"-h")==0) {
		printf("Usage: %s\n",argv[0]);
		printf("[--update-db / -u]: updates the signature databases\n");
		printf("[--scanhash / -h]: scans a hash\n");
		printf("[--scanfile / -s]: scans a file\n");
		printf("[--scanfolder / -f]: scans all the files inside a folder\n");
		printf("[--scanfolderrecursive / -r]: scans all the files inside a folder recursively\n");
		printf("[--delete / -d]: deltetes the files that where flagged as malicious in the last scan\n");
		#ifdef os_win
		printf("[--scanrunning / -p]: scan all running processes\n");
		#endif
	}

	//Update the database
	else if(strcmp("--update-db",argv[1])==0 or strcmp("-u",argv[1])==0) {
		donwload_preindexed_files();
	}

	//Show av version
	else if(strcmp("--version",argv[1])==0 or strcmp("-v",argv[1])==0 ) {
		printf("Jakach av3\nVersion: 1.0.1\n");
	}

	//Scan a single Hash
	else if(strcmp("--scanhash",argv[1])==0 or strcmp("-h",argv[1])==0 ) {
		printf("scanning hash...\n");
		switch(scan_hash(argv[2])) {
			case 0:
				printf("All good, no virus found!\n");
				break;
			case 1:
				printf("Warning, virus found!\n");
				break;
			default:
				printf("Error, an error occured while scanning!\n");
				break;
		}
	}

	//scan a single file
	else if(strcmp("--scanfile",argv[1])==0 or strcmp("-s",argv[1])==0 ) {
		if(get_hash(argv[2],hash)==0) {
			printf("Error, an error occured while scanning!\n");
		} else {
			printf("scanning file %s...\n",argv[2]);
			switch(scan_hash(hash)) {
				case 0:
					printf("All good, no virus found!\n");
					break;
				case 1:
					printf("Warning, virus found!\n");
					break;
				default:
					printf("Error, an error occured while scanning!\n");
					break;
			}
		}
	}

	//scan a folder, non recursivly and single threaded
	else if(strcmp("--scanfolder",argv[1])==0 or strcmp("-f",argv[1])==0 ) {
#ifdef os_win
		if((virus=fopen("c:\\programdata\\jakach\\se\\hashes\\virus.jdbf","w"))==0)
			return 2;
#endif
#ifdef os_linux
		if((virus=fopen("/etc/jakach/virus.jdbf","w"))==0)
			return 2;
#endif
		dp = opendir (argv[2]);
		if (dp != NULL) {
			while (ep = readdir (dp)) {
				strcpy(a,ep->d_name);
#ifdef os_win
				sprintf(fullpath,"%s\\%s",argv[2],a);
				DWORD attrs = GetFileAttributesA(fullpath);
				if (attrs & FILE_ATTRIBUTE_DIRECTORY) {
				} else {
					printf("Scanning file %s...\n",fullpath);
					if(get_hash(fullpath,hash)==0) {
						printf("Error, an error occured while scanning!\n");
					}
					switch(scan_hash(hash)) {
						case 0:
							printf("All good, no virus found!\n");
							break;
						case 1:
							printf("Warning, virus found!\n");
							fprintf(virus,"%s\n",fullpath);
							break;
						default:
							printf("Error, an error occured while scanning!\n");
							break;
					}
				}
#endif
#ifdef os_linux
				strcpy(a,ep->d_name);
				sprintf(fullpath,"%s\\%s",argv[2],a);
				if(is_file(fullpath)) {
					printf("Scanning file %s...\n",fullpath);
					if(get_hash(fullpath,hash)==0) {
						printf("Error, an error occured while scanning!\n");
					}
					switch(scan_hash(hash)) {
						case 0:
							printf("All good, no virus found!\n");
							break;
						case 1:
							printf("Warning, virus found!\n");
							fprintf(virus,"%s\n",fullpath);
							break;
						default:
							printf("Error, an error occured while scanning!\n");
							break;
					}
				}
#endif
			}
		}
		(void) closedir (dp);
		fclose(virus);
		print_sumary();
	}

	//scan a folder recursively and multithreaded
	else if(strcmp("--scanfolderrecursive",argv[1])==0 or strcmp("-r",argv[1])==0 ) {
		scan_recursive_dir(argv[2]);
		printf("Waiting for the threads to complete theyr work (20 Seconds)\n");
		sleep(20);
		print_sumary();
	}

	//delete virus files
	else if(strcmp("--delete",argv[1])==0 or strcmp("-d",argv[1])==0 ) {
		printf("Start deleting\n");
		path_a[0]='\0';
#ifdef os_win
		if((virus=fopen("c:\\programdata\\jakach\\se\\hashes\\virus.jdbf","r"))==0)
			return 2;
#endif
#ifdef os_linux
		if((virus=fopen("/etc/jakach/virus.jdbf","r"))==0)
			return 2;
#endif
		while(!feof(virus)) {
			fgets(path_a,395,virus);
			if(!feof(virus)) {
				path_a[strlen(path_a)-1]='\0';
				printf("deleting %s\n",path_a);
				remove(path_a);
			}
		}
		printf("Done\n");
		fclose(virus);
	}

#ifdef os_win
	//scan running apps
	else if(strcmp("--scanrunning",argv[1])==0 or strcmp("-p",argv[1])==0 ){
		//printf("hi");
		system("powershell -c \"Get-WmiObject win32_process | Select-Object ExecutablePath | Out-File -FilePath c:\\programdata\\jakach\\se\\apps.jdbf -Encoding utf8\"");
		scan_list();
		printf("Waiting for the threads to complete theyr work (20 Seconds)\n");
		sleep(20);
		print_sumary();
	}
#endif
	//throw error
	else {
		printf("Error, command not found!\n\n");
		printf("Usage: %s\n",argv[0]);
		printf("[--update-db / -u]: updates the signature databases\n");
		printf("[--scanhash / -h]: scans a hash\n");
		printf("[--scanfile / -s]: scans a file\n");
		printf("[--scanfolder / -f]: scans all the files inside a folder\n");
		printf("[--scanfolderrecursive / -r]: scans all the files inside a folder recursively\n");
		printf("[--delete / -d]: deltetes the files that where flagged as malicious in the last scan\n");
		#ifdef os_win
		printf("[--scanrunning / -p]: scan all running processes\n");
		#endif
	}
	return 0;
}
