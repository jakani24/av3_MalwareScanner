#ifndef AUTOSCAN_CPP
#define AUTOSCAN_CPP
#include <cstring>
#include <unistd.h>
#include <iostream>
#include <dirent.h>
#include <thread>
#include <sys/stat.h>
#include "../os.h"
#include "scan.h"
#include "../hash/hash.h"
//update the db file for a specific folder. this file stores the filenames of the files in the specific folder
void update_index(char*folder,char*fname)//folder=the actual folder path;;; fname=the relative name of the db file for the folder
{
	FILE*fp;
	char path[300];
	#ifdef os_win
	sprintf(path,"c:\\ProgramData\\jakach\\se\\folders\\%s.jdbf",fname);
	#endif
	#ifdef os_linux
	sprintf(path,"/etc/jakach/folders/%s.jdbf",fname);
	#endif
	if((fp=fopen(path,"w"))==0)
	{
		printf("FATALE ERROR\n");
	}
	else
	{
		  DIR *dp;
		  struct dirent *ep;
		  char a[300];
		  dp = opendir (folder);
		  if (dp != NULL)
		    {
		      while (ep = readdir (dp))
		      {
		      		strcpy(a,ep->d_name);
		     	//	puts(ep->d_name);
		     		if((strcmp(a,".."))!=0 && (strcmp(a,"."))!=0)
		     			fprintf(fp,"%s\n",a);
			  }
		      (void) closedir (dp);
		    }
		  else
		    {
		    	perror ("Couldn't open the directory");
			}
		fclose(fp);
	}
}

//check if there are new files in the folders
void check_index(char*folder,char*fname)//folder=the path of the folder to check;;; fname=relative name of the (internal) db file for the folder
{
	FILE*fp;
	FILE*virus;
	bool scan;
	char path[300];
	char hash[50];
	#ifdef os_win
	sprintf(path,"c:\\ProgramData\\jakach\\se\\folders\\%s.jdbf",fname);
	#endif
	#ifdef os_linux
	sprintf(path,"/etc/jakach/folders/%s.jdbf",fname);
	#endif
	if((fp=fopen(path,"r"))==0)
	{
		printf("FATALE ERROR:%s\n",path);
	}
	else
	{
		  DIR *dp;
		  struct dirent *ep;
		  char a[300];
		  char buf[300];
		  int wt_secure=0;
		  bool wt_scan=true;
		  dp = opendir (folder);
		  if (dp != NULL)
		    {
		      while (ep = readdir (dp))
		      {
		      		strcpy(a,ep->d_name);
		     		if((strcmp(a,".."))!=0 && (strcmp(a,"."))!=0)
					{
						rewind(fp);
						scan=true;
						while(!feof(fp))
						{
							fgets(buf,295,fp);
							buf[strlen(buf)-1]='\0';
							if((strcmp(a,buf))==0)
								scan=false;
						}
						//is it a folder?
						#ifdef os_win
						sprintf(path,"%s\\%s",folder,a);
						#endif
						#ifdef os_linux
						sprintf(path,"%s/%s",folder,a);
						#endif	
				        std::string filepath = std::string(folder) +"/" + ep->d_name;
				        struct stat file_info;
				        if (stat(filepath.c_str(), &file_info) != 0) {
				            continue;
				        }
				        if (S_ISDIR(file_info.st_mode)) {
				        	scan=false;
				        } 
				        
						if(scan)
						{
							get_hash(path,hash);
							printf("Scanning file %s...\n",path);
							int result=scan_hash(hash);
							if(result)
							{
								#ifdef os_win
								virus=fopen("c:\\programdata\\jakach\\se\\hashes\\virus.jdbf","a");
								#endif
								#ifdef os_linux
								virus=fopen("/etc/jakach/virus.jdbf","a");
								#endif
								fprintf(virus,"%s\n",path);
								fclose(virus);
							}
						}	
					}
			  }
		      (void) closedir (dp);
		    }
		  else
		    {
		    	perror ("Couldn't open the directory");
			}
		fclose(fp);
	}	
}
#endif
