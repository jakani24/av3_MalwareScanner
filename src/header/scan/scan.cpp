#ifndef SCAN_CPP
#define SCAN_CPP
#include <cstring>
#include <iostream>
#include <dirent.h>
#include <sys/stat.h>
#include "scan.h"
#include "../os.h"
#include "../hash/hash.h"
int scan_hash(char*to_scan)//returns 0 if no virus and 1 if virus or every other value if an error occures
{
	char hash[55];
	char path[500];
	FILE*fp;
	#ifdef os_win
	sprintf(path,"c:\\programdata\\jakach\\se\\hashes\\%c.jdbf",to_scan[0]);
	#endif
	#ifdef os_linux
	sprintf(path,"/etc/jakach/%c.jdbf",to_scan[0]);
	#endif
	//printf("Searching hash in file %s with hash %s\n",path,to_scan);
	if((fp=fopen(path,"r"))==0)
	{
		return 2;
	}
	else
	{
		while(!feof(fp))
		{
			fscanf(fp,"%50s",&hash);
			if(strcmp(hash,to_scan)==0)//44d88612fea8a8f36de82e1278abb02f = eicar test file
			{
				return 1;
			}
		}
		fclose(fp);
	}
	return 0;
}


int scan_recursive_dir(const char* dir_path) {
	char hash[50];
	char path_a[400];
	FILE*virus;
	#ifdef os_win
	if((virus=fopen("c:\\programdata\\jakach\\se\\hashes\\virus.jdbf","w"))==0)
		return 1;
	#endif
	#ifdef os_linux
	if((virus=fopen("/etc/jakach/virus.jdbf","w"))==0)
		return 1;
	#endif
    DIR* directory = opendir(dir_path);
    if (directory == nullptr) {
        
        return 1;
    }

    dirent* entry;
    while ((entry = readdir(directory)) != nullptr) {
        if (strcmp(entry->d_name, ".") == 0 || strcmp(entry->d_name, "..") == 0) {
            // Skip the current and parent directories
            continue;
        }

        std::string path = std::string(dir_path) + "/" + entry->d_name;

        struct stat file_info;
        if (stat(path.c_str(), &file_info) != 0) {
            continue;
        }

        if (S_ISDIR(file_info.st_mode)) {
            scan_recursive_dir(path.c_str());  // Recurse into subdirectory
        } else if (S_ISREG(file_info.st_mode)) {
        	strcpy(path_a,path.c_str());
            get_hash(path_a,hash);
            printf("Scanning file %s...\n",path_a);
            //sleep(1);
			switch(scan_hash(hash))
			{
				case 0:
					printf("All good, no virus found!\n");
				break;
				case 1:
					printf("Warning, virus found!\n");
					fprintf(virus,"%s\n",path_a);
				break;
				default:
					printf("Error, an error occured while scanning!\n");
				break;
			}
        }
    }
	fclose(virus);
    closedir(directory);
    return 0;
}

#endif