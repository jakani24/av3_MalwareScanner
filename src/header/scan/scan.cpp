#ifndef SCAN_CPP
#define SCAN_CPP
#include <cstring>
#include <unistd.h>
#include <iostream>
#include <dirent.h>
#include <thread>
#include <sys/stat.h>
#include "scan.h"
#include "../os.h"
#include "../hash/hash.h"
int num_threads=0;
int scan_hash(char*to_scan)//returns 0 if no virus and 1 if virus or every other value if an error occures
{
	char hash[55];
	char path[500];
	FILE*fp;
	#ifdef os_win
	sprintf(path,"c:\\programdata\\jakach\\se\\hashes\\%c.jdbf",to_scan[0]);
	#endif
	#ifdef os_linux
	sprintf(path,"/etc/jakach/%c.jdbf",to_scan[0]);
	#endif
	//printf("Searching hash in file %s with hash %s\n",path,to_scan);
	if((fp=fopen(path,"r"))==0)
	{
		return 2;
	}
	else
	{
		while(!feof(fp))
		{
			fscanf(fp,"%50s",&hash);
			if(strcmp(hash,to_scan)==0)//44d88612fea8a8f36de82e1278abb02f = eicar test file
			{
				return 1;
			}
		}
		fclose(fp);
	}
	return 0;
}
int scan_hash_t(char*to_scan_,char*path_)//returns 0 if no virus and 1 if virus or every other value if an error occures
{
	num_threads++;
	thread_local char to_scan[50];
	thread_local char to_scan_p[500];
	strcpy(to_scan,to_scan_);
	strcpy(to_scan_p,path_);
	thread_local char hash[55];
	thread_local char path[500];
	thread_local FILE*fp;
	thread_local FILE*virus;
	#ifdef os_win
	sprintf(path,"c:\\programdata\\jakach\\se\\hashes\\%c.jdbf",to_scan[0]);
	#endif
	#ifdef os_linux
	sprintf(path,"/etc/jakach/%c.jdbf",to_scan[0]);
	#endif
	//printf("Searching hash in file %s with hash %s\n",path,to_scan);
	if((fp=fopen(path,"r"))==0)
	{
		num_threads--;
		return 2;
	}
	else
	{
		while(!feof(fp))
		{
			fscanf(fp,"%50s",&hash);
			if(strcmp(hash,to_scan)==0)//44d88612fea8a8f36de82e1278abb02f = eicar test file
			{
				#ifdef os_win
				virus=fopen("c:\\programdata\\jakach\\se\\hashes\\virus.jdbf","a");
				#endif
				#ifdef os_linux
				virus=fopen("/etc/jakach/virus.jdbf","a");
				#endif
				fprintf(virus,"%s\n",to_scan_p);
				fclose(virus);
				num_threads--;
				return 1;
			}
		}
		fclose(fp);
	}
	num_threads--;
	return 0;
}

int scan_recursive_dir(const char* dir_path) {
	char hash[50];
	int max_threads=std::thread::hardware_concurrency();
	char path_a[400];
	FILE*virus;
	/*#ifdef os_win
	if((virus=fopen("c:\\programdata\\jakach\\se\\hashes\\virus.jdbf","w"))==0)
		return 1;
	#endif
	#ifdef os_linux
	if((virus=fopen("/etc/jakach/virus.jdbf","w"))==0)
		return 1;
	#endif*/
	fclose(virus);
    DIR* directory = opendir(dir_path);
    if (directory == nullptr) {
        
        return 1;
    }

    dirent* entry;
    while ((entry = readdir(directory)) != nullptr) {
        if (strcmp(entry->d_name, ".") == 0 || strcmp(entry->d_name, "..") == 0) {
            // Skip the current and parent directories
            continue;
        }

        std::string path = std::string(dir_path) +"/" + entry->d_name;

        struct stat file_info;
        if (stat(path.c_str(), &file_info) != 0) {
            continue;
        }

        if (S_ISDIR(file_info.st_mode)) {
            scan_recursive_dir(path.c_str());  // Recurse into subdirectory
        } else if (S_ISREG(file_info.st_mode)) {
        	strcpy(path_a,path.c_str());
            get_hash(path_a,hash);
            printf("Scanning file %s...\n",path_a);
            while(num_threads>=max_threads)
            {
            	sleep(1);
            	printf("WARNING: HIGH USAGE: THREADS:%d\n",num_threads);
			}
            std::thread t(scan_hash_t, hash,path_a);
            t.detach();
            //delay a very short time
            usleep(1000*50);
        }
    }
    closedir(directory);
    return 0;
}

int scan_list()
{
	char hash[50];
	int max_threads=std::thread::hardware_concurrency();
	char path_a[400];
	FILE*virus;
	int cnt=0;

	#ifdef os_win
	if((virus=fopen("c:\\programdata\\jakach\\se\\hashes\\virus.jdbf","w"))==0)
		return 1;
	fclose(virus);
	
	//open file with the processlist
	if((virus=fopen("c:\\programdata\\jakach\\se\\apps.jdbf","r"))==0)
		return 2;	
	#endif
	
	#ifdef os_linux
	if((virus=fopen("/etc/jakach/virus.jdbf","w"))==0)
		return 1;
	fclose(virus);
	
	//open file with the processlist
	if((virus=fopen("/etc/jakach/apps.jdbf","r"))==0)
		return 2;	
	#endif
	
	while(!feof(virus)){
		cnt++;
		fgets(path_a,395,virus);
		if(path_a[1]!=32){
			path_a[strlen(path_a)-1]='\0';
			printf("Scanning file %s...\n",path_a);
		    get_hash(path_a,hash);
		    while(num_threads>=max_threads)
		    {
		    	sleep(1);
		    	printf("WARNING: HIGH USAGE: THREADS:%d\n",num_threads);
			}
		    std::thread t(scan_hash_t, hash,path_a);
		    t.detach();
		    //delay a very short time
		    usleep(1000*50);
		}
	}
	
    return 0;	
}

#endif