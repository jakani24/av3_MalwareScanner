#include <stdlib.h>
#include <stdio.h>
#include <iostream>
#include <cstring>
#define db_files 463
#define os_linux
int i=0;
int download_files();
int make_db();
int main(int argc, char *argv[])
{
	if(argc==2)
	{
 	   if(strcmp(argv[1],"d")==0)
 	   {
 	           printf("Downloading files\n");
 	           download_files();
 	           //printf("Please add the main.hsb and the daily.hsb files into the folder /var/www/html/server and then run the updater with \"u\"\n");
 	   }
 	   else if(strcmp(argv[1],"u")==0)
 	           make_db();
	}
	else
		printf("no parameter supplied\n");

	return 0;
}


int download_files()
{
	char buf[500];
	for (int i=0;i<db_files;i++)
	{
		#ifdef os_linux
		sprintf(buf,"curl https://virusshare.com/hashfiles/VirusShare_%.5d.md5 -o /var/www/html/server/%d.md5 --insecure",i,i);
		#endif
		printf("downloading file %d = %.1f%% \n",i,(float)100/db_files*i);
		system(buf);
	}
	//https://database.clamav.net/main.cvd
	//daily.cvd
	#ifdef os_linux
	sprintf(buf,"curl https://database.clamav.net/main.cvd -o /var/www/html/server/main.cvd --insecure");
	#endif
	printf("downloading file %d = %.1f%% \n",i,(float)100/db_files*i);
	system(buf);
	#ifdef os_linux
	sprintf(buf,"curl https://database.clamav.net/daily.cvd -o /var/www/html/server/daily.cvd --insecure");
	#endif
	printf("downloading file %d = %.1f%% \n",i,(float)100/db_files*i);
	system(buf);
	//unpack
	system("sigtool -u /var/www/html/server/main.cvd");
	system("sigtool -u /var/www/html/server/daily.cvd");
	return 0;
}

int make_db()
{
	//FILE*bf;
	FILE*files[36];
	FILE*fp;
	char hash[55];
	char buf[500];
	char path[500];
	#ifdef os_linux
	//if((bf=fopen("/etc/jakach/hash_database.jdbf","w"))==0)
	files[0]=fopen("/var/www/html/server/a.jdbf","w");
	files[1]=fopen("/var/www/html/server/b.jdbf","w");
	files[2]=fopen("/var/www/html/server/c.jdbf","w");
	files[3]=fopen("/var/www/html/server/d.jdbf","w");
	files[4]=fopen("/var/www/html/server/e.jdbf","w");
	files[5]=fopen("/var/www/html/server/f.jdbf","w");
	files[26]=fopen("/var/www/html/server/0.jdbf","w");
	files[27]=fopen("/var/www/html/server/1.jdbf","w");
	files[28]=fopen("/var/www/html/server/2.jdbf","w");
	files[29]=fopen("/var/www/html/server/3.jdbf","w");
	files[30]=fopen("/var/www/html/server/4.jdbf","w");
	files[31]=fopen("/var/www/html/server/5.jdbf","w");
	files[32]=fopen("/var/www/html/server/6.jdbf","w");
	files[33]=fopen("/var/www/html/server/7.jdbf","w");
	files[34]=fopen("/var/www/html/server/8.jdbf","w");
	files[35]=fopen("/var/www/html/server/9.jdbf","w");	
	#endif
	//{
	//	return 1;
	//}

	for(int i=0;i<db_files;i++)
	{
		#ifdef os_linux
		sprintf(path,"/var/www/html/server/%d.md5",i);
		#endif

		printf("creating database file(%.1f%%) \n",(float)100/db_files*i);
		if((fp=fopen(path,"r"))==0)
		{
			return 2;
		}
		else
		{
			while(!feof(fp))
			{
				fscanf(fp,"%32s",&hash);
				//fscanf(fp,"%100s",&buf);
				switch(hash[0])
				{
					case 'a':
						fprintf(files[0],"%s\n",hash);
					break;
											case 'b':
						fprintf(files[1],"%s\n",hash);
					break;
											case 'c':
						fprintf(files[2],"%s\n",hash);
					break;
											case 'd':
						fprintf(files[3],"%s\n",hash);
					break;
											case 'e':
						fprintf(files[4],"%s\n",hash);
					break;
											case 'f':
						fprintf(files[5],"%s\n",hash);
					break;
											case '0':
						fprintf(files[26],"%s\n",hash);
					break;
											case '1':
						fprintf(files[27],"%s\n",hash);
					break;
											case '2':
						fprintf(files[28],"%s\n",hash);
					break;
											case '3':
						fprintf(files[29],"%s\n",hash);
					break;
											case '4':
						fprintf(files[30],"%s\n",hash);
					break;
											case '5':
						fprintf(files[31],"%s\n",hash);
					break;
											case '6':
						fprintf(files[32],"%s\n",hash);
					break;
											case '7':
						fprintf(files[33],"%s\n",hash);
					break;
											case '8':
						fprintf(files[34],"%s\n",hash);
					break;
											case '9':
						fprintf(files[35],"%s\n",hash);
					break;
					default:
						//printf("Unknown file %s\n",hash);
					break;
				}
			//	fprintf(bf,"%s\n",hash);
			}
			fclose(fp);
		}
	}
	//now open the clamav files and copy theyr hashes
		sprintf(path,"/var/www/html/server/daily.hsb");
		printf("creating database file(%.1f%%) \n",(float)100/db_files*i);
		if((fp=fopen(path,"r"))==0)
		{
			return 2;
		}
		else
		{
			while(!feof(fp))
			{
				fscanf(fp,"%32s",&hash);
				fscanf(fp,"%100s",&buf);
				switch(hash[0])
				{
					case 'a':
						fprintf(files[0],"%s\n",hash);
					break;
											case 'b':
						fprintf(files[1],"%s\n",hash);
					break;
											case 'c':
						fprintf(files[2],"%s\n",hash);
					break;
											case 'd':
						fprintf(files[3],"%s\n",hash);
					break;
											case 'e':
						fprintf(files[4],"%s\n",hash);
					break;
											case 'f':
						fprintf(files[5],"%s\n",hash);
					break;
											case '0':
						fprintf(files[26],"%s\n",hash);
					break;
											case '1':
						fprintf(files[27],"%s\n",hash);
					break;
											case '2':
						fprintf(files[28],"%s\n",hash);
					break;
											case '3':
						fprintf(files[29],"%s\n",hash);
					break;
											case '4':
						fprintf(files[30],"%s\n",hash);
					break;
											case '5':
						fprintf(files[31],"%s\n",hash);
					break;
											case '6':
						fprintf(files[32],"%s\n",hash);
					break;
											case '7':
						fprintf(files[33],"%s\n",hash);
					break;
											case '8':
						fprintf(files[34],"%s\n",hash);
					break;
											case '9':
						fprintf(files[35],"%s\n",hash);
					break;
					default:
						//printf("Unknown file %s\n",hash);	
					break;
				}
			//	fprintf(bf,"%s\n",hash);
			}
			fclose(fp);
		}
		sprintf(path,"/var/www/html/server/main.hsb");
		printf("creating database file(%.1f%%) \n",(float)100/db_files*i);
		if((fp=fopen(path,"r"))==0)
		{
			return 2;
		}
		else
		{
			while(!feof(fp))
			{
				fscanf(fp,"%32s",&hash);
				fscanf(fp,"%100s",&buf);
				switch(hash[0])
				{
					case 'a':
						fprintf(files[0],"%s\n",hash);
					break;
											case 'b':
						fprintf(files[1],"%s\n",hash);
					break;
											case 'c':
						fprintf(files[2],"%s\n",hash);
					break;
											case 'd':
						fprintf(files[3],"%s\n",hash);
					break;
											case 'e':
						fprintf(files[4],"%s\n",hash);
					break;
											case 'f':
						fprintf(files[5],"%s\n",hash);
					break;
											case '0':
						fprintf(files[26],"%s\n",hash);
					break;
											case '1':
						fprintf(files[27],"%s\n",hash);
					break;
											case '2':
						fprintf(files[28],"%s\n",hash);
					break;
											case '3':
						fprintf(files[29],"%s\n",hash);
					break;
											case '4':
						fprintf(files[30],"%s\n",hash);
					break;
											case '5':
						fprintf(files[31],"%s\n",hash);
					break;
											case '6':
						fprintf(files[32],"%s\n",hash);
					break;
											case '7':
						fprintf(files[33],"%s\n",hash);
					break;
											case '8':
						fprintf(files[34],"%s\n",hash);
					break;
											case '9':
						fprintf(files[35],"%s\n",hash);
					break;
					default:
						//printf("Unknown file %s\n",hash);	
					break;
				}
			//	fprintf(bf,"%s\n",hash);
			}
			fclose(fp);
		}	
	
	//fclose(bf);
	fclose(files[0]);
	fclose(files[1]);
	fclose(files[2]);
	fclose(files[3]);
	fclose(files[4]);
	fclose(files[5]);

	fclose(files[26]);
	fclose(files[27]);
	fclose(files[28]);
	fclose(files[29]);
	fclose(files[30]);
	fclose(files[31]);
	fclose(files[32]);
	fclose(files[34]);
	fclose(files[33]);
	fclose(files[35]);
	printf("done 100%%\n");		

	return 0;
}
