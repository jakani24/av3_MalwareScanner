#include <stdlib.h>
#include <stdio.h>
#include <iostream>
#include <cstring>
#define db_files 463
#define os_linux
int i=0;
int download_files();
int make_db();
int main(int argc, char *argv[])
{
	if(argc==2)
	{
 	   if(strcmp(argv[1],"d")==0)
 	   {
 	           printf("Downloading files\n");
 	           return download_files();
 	           //printf("Please add the main.hsb and the daily.hsb files into the folder /var/www/html/server and then run the updater with \"u\"\n");
 	   }
 	   else if(strcmp(argv[1],"u")==0)
 	           return make_db();
	}
	else
		printf("no parameter supplied\n");

	return 0;
}


int download_files()
{
	char buf[500];
	for (int i=0;i<db_files;i++)
	{
		#ifdef os_linux
		sprintf(buf,"curl https://virusshare.com/hashfiles/VirusShare_%.5d.md5 -o /var/www/html/server/db/%d.md5 --insecure",i,i);
		#endif
		printf("downloading file %d = %.1f%% \n",i,(float)100/db_files*i);
		system(buf);
	}
	system("freshclam");
	system("cp /var/lib/clamav/main.cvd /var/www/html/server/db");
	system("cp /var/lib/clamav/daily.cvd /var/www/html/server/db");
	system("cd /var/www/html/server/db/ && sigtool -u /var/www/html/server/db/main.cvd");
	system("cd /var/www/html/server/db/ && sigtool -u /var/www/html/server/db/daily.cvd");
	return 0;
}

int make_db()
{
	//FILE*bf;
	FILE*files;
	FILE*fp;
	char hash[55];
	char buf[500];
	char path[500];
	//pfad: /var/www/html/server/

	for(int i=0;i<db_files;i++)
	{
		sprintf(path,"/var/www/html/server/db/%d.md5",i);

		printf("creating database file(%.1f%%) \n",(float)100/db_files*i);
		if((fp=fopen(path,"r"))==0)
		{
			return 2;
		}
		else
		{
			while(!feof(fp))
			{
				fscanf(fp,"%32s",&hash);
				for(int i=0;i<strlen(hash);i++)
				{
					if (hash[i] >= 'A' && hash[i] <= 'Z') {
		          		hash[i] = hash[i] + ('a' - 'A');
		        	}
				}
				sprintf(path,"/var/www/html/server/%c%c.jdbf",hash[0],hash[1]);
				files=fopen(path,"a");
				fprintf(fp,"%s\n",hash);
				fclose(files);
			//	fprintf(bf,"%s\n",hash);
			}
			fclose(fp);
		}
	}
	sprintf(path,"/var/www/html/server/db/main.hsb");

	printf("creating database file(%.1f%%) \n",(float)100/db_files*i);
	if((fp=fopen(path,"r"))==0)
	{
		return 2;
	}
	else
	{
		while(!feof(fp))
		{
			fscanf(fp,"%32s",&hash);
			for(int i=0;i<strlen(hash);i++)
			{
				if (hash[i] >= 'A' && hash[i] <= 'Z') {
	          		hash[i] = hash[i] + ('a' - 'A');
	        	}
			}
			sprintf(path,"/var/www/html/server/%c%c.jdbf",hash[0],hash[1]);
			files=fopen(path,"a");
			fprintf(fp,"%s\n",hash);
			fclose(files);
		//	fprintf(bf,"%s\n",hash);
		}
		fclose(fp);
	}
	sprintf(path,"/var/www/html/server/db/daily.hsb");

	printf("creating database file(%.1f%%) \n",(float)100/db_files*i);
	if((fp=fopen(path,"r"))==0)
	{
		return 2;
	}
	else
	{
		while(!feof(fp))
		{
			fscanf(fp,"%32s",&hash);
			for(int i=0;i<strlen(hash);i++)
			{
				if (hash[i] >= 'A' && hash[i] <= 'Z') {
	          		hash[i] = hash[i] + ('a' - 'A');
	        	}
			}
			sprintf(path,"/var/www/html/server/%c%c.jdbf",hash[0],hash[1]);
			files=fopen(path,"a");
			fprintf(fp,"%s\n",hash);
			fclose(files);
		//	fprintf(bf,"%s\n",hash);
		}
		fclose(fp);
	}
	
	sprintf(path,"/var/www/html/server/own.jdbf");

	printf("creating database file(%.1f%%) \n",(float)100/db_files*i);
	if((fp=fopen(path,"r"))==0)
	{
		return 2;
	}
	else
	{
		while(!feof(fp))
		{
			fscanf(fp,"%32s",&hash);
			for(int i=0;i<strlen(hash);i++)
			{
				if (hash[i] >= 'A' && hash[i] <= 'Z') {
	          		hash[i] = hash[i] + ('a' - 'A');
	        	}
			}
			sprintf(path,"/var/www/html/server/%c%c.jdbf",hash[0],hash[1]);
			files=fopen(path,"a");
			fprintf(fp,"%s\n",hash);
			fclose(files);
		//	fprintf(bf,"%s\n",hash);
		}
		fclose(fp);
	}
}
